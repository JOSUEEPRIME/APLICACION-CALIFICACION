
**Objetivo:** Generar un Diagrama de Flujo Funcional (Swimlane Diagram) de Alto Nivel Técnico.

**Justificación de la Elección:**
La mejor opción para representar este sistema es un **Diagrama de Carriles (Swimlane Diagram)** o un **Diagrama de Secuencia de Sistema**.
*¿Por qué?* Porque el sistema tiene múltiples actores claros (Usuario, Interfaz React, Base de Datos Firestore, IA Gemini) y el valor real está en ver cómo la data fluye entre ellos a través del tiempo, no solo cómo están conectados estáticamente.

**PROMPT DETALLADO:**

"Actúa como un Arquitecto de Software Senior y genera una especificación detallada para crear un Diagrama de Procesos Técnicos (Swimlane Flowchart) que describa el funcionamiento de la aplicación 'Josue Aplicacion Calificación'.

**1. Definición de Carriles (Actores/Sistemas):**
*   **Usuario (Profesor):** Interactúa con la UI, carga archivos y valida resultados.
*   **Cliente Frontend (React/Vite + TypeScript):** Maneja el estado (Context/State), el enrutamiento (URL Hash), y la lógica de negocio.
*   **Servicio de Persistencia (Firebase Firestore):** Almacena cursos, estudiantes, exámenes y las entregas (imágenes Base64 + metadatos). Funciona con listeners en tiempo real (`onSnapshot`).
*   **Motor de IA (Google Gemini 1.5 Flash API):** Procesa las imágenes OCR, analiza el contenido contra la rúbrica y devuelve JSON estructurado.

**2. Flujos Críticos a Representar:**

**A. Flujo de Navegación y Persistencia (State Hydration)**
1.  **Inicio:** El Usuario carga la URL (ej. `app/#course/123/subject/456/exam/789`).
2.  **Cliente Frontend:** Detecta el Hash en `useEffect`.
3.  **Cliente Frontend:** Ejecuta llamadas paralelas `getCourse(123)`, `getSubject(456)`, `getExam(789)` a **Firestore**.
4.  **Firestore:** Retorna los objetos de configuración y la Rúbrica asociada al examen.
5.  **Cliente Frontend:** Establece el estado global y renderiza la vista de 'Calificación' directamente.

**B. Flujo de Carga y Creación de Entregas (Data Ingestion)**
1.  **Usuario:** Selecciona múltiples imágenes de exámenes manuscritos y las arrastra al 'StudentUpload'.
2.  **Cliente Frontend:** Convierte cada imagen a Base64 localmente.
3.  **Cliente Frontend:** Itera sobre los archivos y llama a `createSubmission()`.
4.  **Firestore:** Crea un documento en la colección `submissions`.
    *   *Estado Inicial:* `PENDING`
    *   *Payload:* `{ fileData: "base64...", mimeType: "image/jpeg", courseId: "...", examId: "..." }`
5.  **Cliente Frontend:** El listener `onSnapshot` detecta el nuevo documento y actualiza la lista UI automáticamente.

**C. Flujo de Calificación con IA (The Core Loop)**
1.  **Usuario:** Presiona el botón 'Iniciar Calificación'.
2.  **Cliente Frontend:** Filtra localmente las entregas con estado `PENDING` o `ERROR`.
3.  **Bucle de Procesamiento (Cliente Frontend):**
    *   **Paso 3.1:** Cambia el estado en **Firestore** a `PROCESSING`.
    *   **Paso 3.2 (Llamada IA):** Envía `fileData` (Imagen) + `RubricConfig` (Texto JSON) al **Motor de IA (Gemini)**.
    *   **Paso 3.3 (Análisis IA):** Gemini procesa OCR + Razonamiento. Retorna JSON: `{ studentName: "Juan Pérez", score: 8.5, feedback: "..." }`.
    *   **Paso 3.4 (Matching Algorítmico):** **Cliente** ejecuta algoritmo de Levenshtein comparando `studentName` (OCR) contra la lista de `students` del Curso.
    *   **Paso 3.5 (Persistencia):** Actualiza el documento en **Firestore** con el Resultado, el ID del estudiante encontrado (si aplica) y cambia estado a `COMPLETED`.
    *   **Paso 3.6 (Estadísticas):** Dispara `recalculateStudentStats` en **Firestore** para actualizar el promedio del estudiante.

**D. Visualización y Exportación**
1.  **Firestore:** Notifica cambios de estado (`COMPLETED`) a través de los sockets en tiempo real.
2.  **Cliente Frontend:** Renderiza la tarjeta de 'Submission' con verde (éxito).
3.  **Usuario:** Puede hacer clic para ver el detalle (Modal) o presionar 'Exportar CSV'.

**Formato de Salida Esperado:**
Genera este diagrama usando sintaxis **Mermaid.js** (tipo `sequenceDiagram` o `flowchart TD` con subgraphs) o una descripción visual paso a paso para un diseñador."